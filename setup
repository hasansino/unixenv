#!/bin/bash

# Prerequisites: git & homebrew
#
# Install homebrew:
# `/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"`
# + sudo apt-get install build-essential procps curl file

set -e
# set -x

# --- PREREQUISITES ---
if [ "$(id -u)" -eq 0 ]; then
    echo "Error: running from root is not allowed."
    exit 1
fi
if ! type brew >/dev/null 2>&1; then
    echo "Error: homebrew is required, but not installed."
    exit 1
fi
if ! type git > /dev/null 2>&1; then
    echo "Error: git is required, but not installed."
    exit 1
fi

if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "OS: darwin"
elif [[ "$OSTYPE" == "linux-gnu" ]]; then
    echo "OS: linux"
else
    echo "Unsupported OS."
    exit 1
fi
# --- PREREQUISITES END ---

# --- AUTOUPDATE ---
get_script_path() {
    local source="${BASH_SOURCE[0]}"
    while [ -h "$source" ]; do
        local dir="$( cd -P "$( dirname "$source" )" && pwd )"
        source="$(readlink "$source")"
        [[ $source != /* ]] && source="$dir/$source"
    done
    echo "$( cd -P "$( dirname "$source" )" && pwd )/$( basename "$source" )"
}
get_checksum() {
    local file_path="$1"
    if [[ "$OSTYPE" == "darwin"* ]]; then
        md5 -q "$file_path"
    elif [[ "$OSTYPE" == "linux-gnu" ]]; then
        md5sum "$file_path" | awk '{ print $1 }'
    fi
}

SCRIPT_PATH=$(get_script_path)
echo "Script path: $SCRIPT_PATH"
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "Error: script not found."
    exit 1
fi
OLD_CHECKSUM=$(get_checksum "$SCRIPT_PATH")
echo "Old checksum: $OLD_CHECKSUM"

REPO_URL="https://github.com/hasansino/unixenv.git"
CLONE_DIR="$HOME/unixenv"
if [ -d "$CLONE_DIR" ]; then
    echo "Updating git repo..."
    git -C "$CLONE_DIR" pull origin master
else
    echo "Cloning git repo..."
    git clone "$REPO_URL" "$CLONE_DIR"
fi

NEW_CHECKSUM=$(get_checksum "$SCRIPT_PATH")
echo "New checksum: $NEW_CHECKSUM"
if [ "$OLD_CHECKSUM" != "$NEW_CHECKSUM" ]; then
    echo "Script has been updated. Restarting..."
    exec "$SCRIPT_PATH" "$@"
fi
# --- AUTOUPDATE END ---

# operate in temporary directory
TMP_DIR=$(mktemp -d)
cd "$TMP_DIR"
cleanup() {
    rm -rf "$TMP_DIR"
}
trap cleanup EXIT

# arguments
RUN_FONTS=false
for arg in "$@"; do
    case "$arg" in
        --fonts) RUN_FONTS=true ;;
    esac
done

update_file() {
    local header="#_____UNIXENV_CONFIG_START____"
    local footer="#_____UNIXENV_CONFIG_END______"
    local source="$1"
    local target="$2"

    local escaped_header=$(printf '%s\n' "$header" | sed 's/[][\\/.^$*]/\\&/g')
    local escaped_footer=$(printf '%s\n' "$footer" | sed 's/[][\\/.^$*]/\\&/g')

    if [ ! -f "$target" ]; then
        printf "%s\n%s\n%s\n" "$header" "$source" "$footer" > "$target"
    elif grep -q "$header" "$target" && grep -q "$footer" "$target"; then
        TMP_FILE=$(mktemp)
        printf "%s\n%s\n%s\n" "$header" "$source" "$footer" > "$TMP_FILE" #Removed extra newlines

        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "/$escaped_header/,/$escaped_footer/d" "$target"
        elif [[ "$OSTYPE" == "linux-gnu" ]]; then
            sed -i "/$escaped_header/,/$escaped_footer/d" "$target"
        fi

        cat "$TMP_FILE" >> "$target"
        rm "$TMP_FILE"
    else
        printf "%s\n%s\n%s\n" "$header" "$source" "$footer" >> "$target"
    fi
}

packages() {
    brew install -q ca-certificates \
    wget nano htop watch unzip \
    zoxide fzf eza bat broot navi dust fd hyperfine \
    gotop bottom \
    lazydocker \
    kubectl k9s helm \
    uv gh jq starship glow diff-so-fancy tig \
    gonzo tlrc
    uv tool install -U --python 3.13 posting
}

configs() {
    # ssh
    mkdir -p "$HOME/.ssh"
    cp "$CLONE_DIR/generic/.config/.ssh/config" "$HOME/.ssh/config"
    touch "$HOME/.ssh/config_hosts"
    # nano
    cp "$CLONE_DIR/generic/.config/.nanorc" "$HOME/.nanorc"
    # git
    cp "$CLONE_DIR/generic/.config/.gitconfig" "$HOME/.gitconfig"
    cp "$CLONE_DIR/generic/.config/.gitignore" "$HOME/.gitignore"
    # btm
    cp "$CLONE_DIR/generic/.config/btm.toml" "$HOME/.config/btm.toml"
    # htop
    mkdir -p "$HOME/.config/htop"
    cp "$CLONE_DIR/generic/.config/htop/htoprc" "$HOME/.config/htop/htoprc"
    # eza
    mkdir -p "$HOME/.config/eza"
    cp "$CLONE_DIR/generic/.config/eza/theme.yml" "$HOME/.config/eza/theme.yml"
    # generic
    touch "$HOME/.hushlogin"
    # a bit more complicated cases
    config_docker
}

config_docker() {
    local CONFIG_DIR="$HOME/.docker"
    local CONFIG_FILE="$CONFIG_DIR/config.json"
    local GENERIC_CONFIG="$CLONE_DIR/generic/.config/docker/config.json"

    if ! command -v jq >/dev/null 2>&1; then
        echo "config_docker error: jq is required but not installed." >&2
        return 1
    fi

    mkdir -p "$CONFIG_DIR"

    if [ ! -f "$CONFIG_FILE" ]; then
        cp "$GENERIC_CONFIG" "$CONFIG_FILE"
        echo "Created $CONFIG_FILE from $GENERIC_CONFIG"
    else
        local tmp
        tmp=$(mktemp)
        jq -s '.[0] * .[1]' "$CONFIG_FILE" "$GENERIC_CONFIG" > "$tmp" \
            && cp "$CONFIG_FILE" "$CONFIG_FILE.bak" \
            && mv "$tmp" "$CONFIG_FILE"
        echo "Merged $GENERIC_CONFIG into $CONFIG_FILE (backup at $CONFIG_FILE.bak)"
    fi
}

scripts() {
    mkdir -p "$HOME/.local/bin"
    # alias `goenv`
    ln -sf "$CLONE_DIR/bin/goenv-scp" "$HOME/.local/bin/goenv-scp"
}

fonts() {
    local FONT_URL="https://github.com/microsoft/cascadia-code/releases/download/v2407.24/CascadiaCode-2407.24.zip"
    local FONT_NAME="Cascadia Code"
    local ZIP_FILE="CascadiaCode.zip"

    echo "Installing $FONT_NAME font..."

    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if find "$HOME/.local/share/fonts" /usr/share/fonts 2>/dev/null -type f -name "*Cascadia*.ttf" | grep -q .; then
            echo "✓ $FONT_NAME already installed"
            return 0
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        if find "$HOME/Library/Fonts" 2>/dev/null -type f -name "*Cascadia*.ttf" | grep -q .; then
            echo "✓ $FONT_NAME already installed"
            return 0
        fi
    fi

    # deps
    if ! command -v wget &> /dev/null; then
        echo "Error: wget is required for font installation."
        return 1
    fi
    if ! command -v unzip &> /dev/null; then
        echo "Error: unzip is required for font installation."
        return 1
    fi

    local FONT_TMP_DIR
    FONT_TMP_DIR=$(mktemp -d)
    pushd "$FONT_TMP_DIR" > /dev/null

    wget -q "$FONT_URL" -O "$ZIP_FILE"
    unzip -q "$ZIP_FILE"

    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        local FONT_DIR="$HOME/.local/share/fonts"
        mkdir -p "$FONT_DIR"
        find . -name "*.ttf" -exec cp {} "$FONT_DIR" \;
        command -v fc-cache &>/dev/null && fc-cache -fv > /dev/null 2>&1
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        local FONT_DIR="$HOME/Library/Fonts"
        mkdir -p "$FONT_DIR"
        find . -name "*.ttf" -exec cp {} "$FONT_DIR" \;
    else
        echo "Warning: Font installation not supported for OS: $OSTYPE"
        popd > /dev/null
        rm -rf "$FONT_TMP_DIR"
        return 1
    fi

    popd > /dev/null
    rm -rf "$FONT_TMP_DIR"

    echo "✓ $FONT_NAME font installed successfully"
    return 0
}

if [[ "$OSTYPE" == "darwin"* ]]; then
    # .zprofile
    update_file "$(cat "$CLONE_DIR/macos/.zprofile")" "$HOME/.zprofile"
    # .zshrc
    update_file "$(cat "$CLONE_DIR/generic/rc" "$CLONE_DIR/macos/.zshrc")" "$HOME/.zshrc"
    # .zsh_aliases
    update_file "$(cat "$CLONE_DIR/macos/.zsh_aliases" "$CLONE_DIR/generic/aliases")" "$HOME/.zsh_aliases"
    # modules
    packages
    configs
    scripts
    if [ "$RUN_FONTS" = true ]; then
        fonts
    fi
elif [[ "$OSTYPE" == "linux-gnu" ]]; then
    # .bash_profile
    update_file "$(cat "$CLONE_DIR/linux/.bash_profile")" "$HOME/.bash_profile"
    # .bashrc
    update_file "$(cat "$CLONE_DIR/generic/rc" "$CLONE_DIR/linux/.bashrc")" "$HOME/.bashrc"
    # .bash_aliases
    update_file "$(cat "$CLONE_DIR/linux/.bash_aliases" "$CLONE_DIR/generic/aliases")" "$HOME/.bash_aliases"
    # modules
    packages
    configs
    scripts
    if [ "$RUN_FONTS" = true ]; then
        fonts
    fi
fi

echo "Finished."
