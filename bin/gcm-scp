#!/bin/bash

# Push staged changes with ai-generated commit message

set -euo pipefail

if ! git rev-parse --git-dir >/dev/null 2>&1; then
  echo -e "Not in a git repository."
  exit 1
fi

git add -A

if [[ -z "$(git diff --cached --name-only)" ]]; then
  echo -e "Nothing staged to commit."
  exit 0
fi

diff="$(git diff --cached)"
max_chars=50000
if (( ${#diff} > max_chars )); then
  diff="${diff:0:max_chars}
... <diff truncated at ${max_chars} characters>"
fi

prompt="
You are an expert software engineer. 
Draft a concise, helpful Git commit message for the staged changes below.

Rules:
- Prefer Conventional Commits (e.g., feat:, fix:, chore:, docs:, refactor:, test:, build:)
- 1 short subject line (<= 72 chars), then optional body with wrapped bullets
- No code fences, no quotes around the subject, no emojis
- Be specific (mention files/areas and intent), but don't exceed a few lines
- Return ONLY the commit message, nothing else

STAGED DIFF:
${diff}"

if ! command -v claude >/dev/null 2>&1; then
  echo -e "Claude CLI not found."
  exit 1
fi

claude_msg="$(claude --model claude-sonnet-4-0 -p "$prompt" 2>&1)"
claude_exit=$?

if [[ $claude_exit -ne 0 ]]; then
  echo -e "Claude Error: ${claude_msg:0:100}"
  exit 1
fi

tmpfile="$(mktemp)"
echo "$claude_msg" > "$tmpfile"

if git commit -F "$tmpfile"; then
  rm -f "$tmpfile"
  if git rev-parse --abbrev-ref --symbolic-full-name @{u} >/dev/null 2>&1; then
    if git push; then
      echo -e "Push successful."
    else
      echo -e "Push failed."
      exit 1
    fi
  else
    branch="$(git rev-parse --abbrev-ref HEAD)"
    if git push -u origin "$branch"; then
      echo -e "Push successful."
    else
      echo -e "Push failed."
      exit 1
    fi
  fi
else
  rm -f "$tmpfile"
  echo -e "Commit failed."
  exit 1
fi
